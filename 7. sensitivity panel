#--------------------------------------hjy---------------------------------------
#### Profiles loading
library("ggpmisc")
theme_set(ggpubr::theme_pubr()+
            theme(legend.position = "top"))
library("tidyverse")
library("pheatmap")
library("Hmisc")
library("ggplot2")
library("Maaslin2")
library("randomForest")
library("caret")
library("ggpubr")
library("rfPermute")
library("Boruta")
library("reshape2")
library("relaimpo")
library("rsq")

#----------------------------??same_species??----------------------------
setwd("D:/JANE/SYSU/xmktz/data_analysis/analysis_ABSI") #?ļ?????·??
metadata <- read.csv("Metadata_same??BMI_ABSI??.csv",row.names = 1,check.names = F)
ABSI_list <- subset(metadata,select = c("ABSI","Age","Sex","activity_grade","alcohol","smoke","DD","Chronic_disease"))
species <- read.csv("species_caculate_experience_lm.csv", header = T,sep = ",",check.names = F,row.names = 1) 
merge<- merge(ABSI_list,species,by="row.names")
rownames(merge) <- merge[,1]
merge <- merge[,2:10]
#write.csv(merge,"??same??species_lm.csv")


#----------------------------??same_pathway??----------------------------
setwd("D:/JANE/SYSU/xmktz/data_analysis/analysis_ABSI") #?ļ?????·??
metadata <- read.csv("Metadata_same??BMI_ABSI??.csv",row.names = 1,check.names = F)
ABSI_list <- subset(metadata,select = c("ABSI","Age","Sex","activity_grade","alcohol","smoke","DD","Chronic_disease"))
species <- read.csv("pathway_caculate_experience_lm.csv", header = T,sep = ",",check.names = F,row.names = 1) 
merge<- merge(ABSI_list,species,by="row.names")
rownames(merge) <- merge[,1]
merge <- merge[,2:10]
#write.csv(merge,"??same??pathway_lm.csv")


#----------------------------??different_species??----------------------------
setwd("D:/JANE/SYSU/xmktz/data_analysis/analysis_ABSI") #?ļ?????·??
metadata <- read.csv("Metadata_different??BMI_ABSI??.csv",row.names = 1,check.names = F)
ABSI_list <- subset(metadata,select = c("ABSI","Age","Sex","activity_grade","alcohol","smoke","DD","Chronic_disease"))
species <- read.csv("species_caculate_experience_lm.csv", header = T,sep = ",",check.names = F,row.names = 1) 
merge<- merge(ABSI_list,species,by="row.names")
rownames(merge) <- merge[,1]
merge <- merge[,2:10]
#write.csv(merge,"??different??species_lm.csv")

#----------------------------??different_pathway??----------------------------
setwd("D:/JANE/SYSU/xmktz/data_analysis/analysis_ABSI") #?ļ?????·??
metadata <- read.csv("Metadata_different??BMI_ABSI??.csv",row.names = 1,check.names = F)
ABSI_list <- subset(metadata,select = c("ABSI","Age","Sex","activity_grade","alcohol","smoke","DD","Chronic_disease"))
species <- read.csv("pathway_caculate_experience_lm.csv", header = T,sep = ",",check.names = F,row.names = 1) 
merge<- merge(ABSI_list,species,by="row.names")
rownames(merge) <- merge[,1]
merge <- merge[,2:10]
#write.csv(merge,"??different??pathway_lm.csv")


#----------------------------?????¿?ʼ----------------------------

colnames(merge)[9] <- "score"
#???о???panel
summary(lm(ABSI~score,data=merge))
#panel 1
a1 <- lm(ABSI~score+Age+Sex,data=merge,na.action=na.exclude)
b1 <- lm(ABSI~Age+Sex,data=merge,na.action=na.exclude)
summary(a1)
summary(b1)
anova(a1,b1)
#panel 2
a2 <-lm(ABSI~score+Age+Sex+activity_grade+alcohol+smoke+DD,data=merge,na.action=na.exclude)
b2 <- lm(ABSI~Age+Sex+activity_grade+alcohol+smoke+DD,data=merge,na.action=na.exclude)
summary(a2)
summary(b2)
anova(a2,b2)
#panel 3
a3 <- lm(ABSI~score+Age+Sex+activity_grade+alcohol+smoke+DD+Chronic_disease,data=merge,na.action=na.exclude)
b3 <- lm(ABSI~Age+Sex+activity_grade+alcohol+smoke+DD+Chronic_disease,data=merge,na.action=na.exclude)
summary(a3)
summary(b3)
anova(a3,b3)
#˳??1?????Ա?2???ʽ3????4??
anova(b1,b2)
anova(b2,b3)
anova(b3,a3)



#---------------------------------logistics?ع?---------------------------------
group <- subset(metadata,select = c("ABSI_obesity","Age","Sex","activity_grade","alcohol","smoke","DD","Chronic_disease"))
lm <- species
mer <- merge(lm,group,by="row.names")
colnames(mer)[1] <- "ID"
colnames(mer)[2] <- "score"
#???о???panel
#a <-glm(formula = ABSI_obesity~score,family = binomial(link = "logit"),data=mer)
#panel 1
#a1 <- glm(formula = ABSI_obesity~score+Age+Sex,family = binomial(link = "logit"),data=mer)
#b1 <- glm(formula = ABSI_obesity~Age+Sex,family = binomial(link = "logit"),data=mer)
#panel 2
#a2 <-glm(formula = ABSI_obesity~score+Age+Sex+activity_grade+alcohol+smoke+DD,family = binomial(link = "logit"),data=mer)
#b2 <- glm(formula = ABSI_obesity~Age+Sex+activity_grade+alcohol+smoke+DD,family = binomial(link = "logit"),data=mer)
#panel 3
a3 <- glm(formula = ABSI_obesity~score+Age+Sex+activity_grade+alcohol+smoke+DD+Chronic_disease,family = binomial(link = "logit"),data=mer)
#b3 <- glm(formula = ABSI_obesity~Age+Sex+activity_grade+alcohol+smoke+DD+Chronic_disease,family = binomial(link = "logit"),data=mer)


#ȡPֵ\waldֵ\Bֵ\ORֵ\ORֵ??95%CI
cluculated <- a3 #??
p<-summary(cluculated)$coefficients[,4]
wald<-summary(cluculated)$coefficients[,3]^2
valueB<-coef(cluculated)
valueOR<-exp(coef(cluculated))
confitOR<-exp(confint(cluculated))
#?Ʊ?
logistics_a3 <-data.frame(
  B=round(valueB,3),
  Wald=round(wald,3),
  OR_with_CI=paste(round(valueOR,3),"(",
                   round(confitOR[,1],3),"~",round(confitOR[,2],3),")",sep=""),
  P=format.pval(p,digits = 3,eps=0.001))

write.csv(logistics_a3,file="111.csv",row.names = TRUE)
#--------------------------------------hjy---------------------------------------
