#------------------hjy--------------------------
#beta diversity
#library
library(vegan)
library(ggplot2)
library(ggrepel)
library(magrittr)

#PCOA
## read
setwd("  ") 
pri <- read.csv("genus_1419.csv",  row.names = 1, sep = ",",header = T,stringsAsFactors =F, check.names = F) 
pri <- as. data.frame(t(pri))
group <- read.csv("graphpad1.csv", row.names = 1, header = T, sep = ",", check.names = F)
merge<- merge(pri,group,by="row.names")
colnames(merge)[1]<-"ID"
write.csv(merge,"graphpad2.csv",row.names = F)

pri$ID <- rownames(pri)
group1 <- as.data.frame(rownames(group))
colnames(group1)<-"ID"
group1$ABSI_group <- group$group1
mer <- merge(group1 , pri, by = "ID")
pri <- mer[,c(3:(ncol(mer)))] 

group <- data.frame(mer[,c('ABSI_group')])
row.names(group)=mer[,1]
colnames(group) <- ("ABSI_group")

##vegan package PERMANOVA
set.seed(1234)
adonis_pri2 <- adonis2(pri~factor(ABSI_group), group, distance = 'bray', permutations = 999,by="margin")
adonis_pri$aov.tab[1,6]

##------------PCA---------------
row.names(pri)<- mer[,1]
pri1 <- pri[,which(apply(pri, 2, var)!= 0)]
pca <- prcomp(pri1,center = TRUE, scale. = TRUE)

# Calculate the weight of each piece of raw data on each PC
pca.var <- pca$sdev^2 

#Calculate the ratio of each PC to the sum of all 
PCA.var.per <- round(pca.var/sum(pca.var)*100,2)
##Visualize with a histogram
barplot(pca.var.per, main="Scree Plot", xlab="Principal Component", ylab="Percent Variation")  

# PC1 and PC2
pca.data <- data.frame(row.names=rownames(pca$x),
                       PC1=pca$x[,1],
                       PC2=pca$x[,2])
pca.data <- cbind.data.frame(pca.data,group)

##Add the centroids of the two groups to the graph 
#calculate the mean values of the two groups of samples in the PCOA coordinates, respectively
#and display them as large central points
group_average <- aggregate(cbind(PC1, PC2)~ABSI_group, data = pca.data, FUN = mean)

# ggplot2
ggplot(pca.data)+
  geom_point(aes(x=PC1, y=PC2,color=as.factor(ABSI_group)),size = 0.5)+ 
  theme(panel.grid = element_blank(), panel.background = element_blank(),
        axis.line = element_line(color = 'black'), legend.key = element_blank()) +
  labs(x ="PC1", y = "PC2",title="PCA" ,color = '')+
  #scale_color_manual(values=c("#45bd9b","#fece71","#f05179"),breaks=c("0", "1" , "2"),labels=c("WC_obsity", "same", "ABSI_obesity"))+
  scale_color_manual(values=c("#f05179","#45bd9b"),breaks=c("1","2"),labels=c("ABSI_obesity","WC_obsity"))+
  scale_x_continuous(limits = c(-1,1))+
  scale_y_continuous(limits = c(-5,3))+
  stat_ellipse(aes(x = PC1, y = PC2, color=as.factor(ABSI_group)), level = 0.95, linetype = 2, show.legend = FALSE) +  
  geom_point(data = group_average, aes(x = PC1, y = PC2, color=as.factor(ABSI_group)), size = 2, show.legend = FALSE)+  
  annotate('text', label = 'PERMANOVA', x = 0, y = -4, size = 3.5) +
  annotate('text', label = sprintf('italic(P) == %.3f', adonis_pri$aov.tab[1,6]), x = 0, y = -4.5, size = 3.5, parse = TRUE)
#------------------------------
class(pca.data$ABSI_group)  # factor
mode(pca.data$ABSI_group)   # numeric
table(pca.data$ABSI_group)  # setosa versicolor  virginica
##-----------PCOA---------------
#PCoA
##Calculate the distance
pcoa_dis <- vegdist(pri, method = 'bray')  #bray

#PCoA oeder
pcoa <- cmdscale(pcoa_dis, k = (nrow(pri) - 1), eig = TRUE)
#Extract the contribution of the first two axes
pcoa_exp <- pcoa$eig/sum(pcoa$eig)
pcoa1 <- paste('PCoA1 :', round(100*pcoa_exp[1], 2), '%')
pcoa2 <- paste('PCoA2 :', round(100*pcoa_exp[2], 2), '%')
#Extract the coordinates of the first two axes and add the grouping information for the sample
site <- data.frame(pcoa$point)[1:2]
site <- cbind. data.frame(site, group)
names(site)[1:3] <- c('pcoa1', 'pcoa2','group')

#ggplot2
##add the center of mass to the graph 
#calculate the mean of the two sets of samples in PCOA coordinates, respectively
#and display it as a large point in the center
group_average <- aggregate(cbind(pcoa1, pcoa2)~group, data = site, FUN = mean)

##ggplot
ggplot(site)+
  geom_point(aes(x=pcoa1, y=pcoa2,color=as.factor(group)),size = 0.5)+  
  theme(panel.grid = element_blank(), panel.background = element_blank(),
        axis.line = element_line(color = 'black'), legend.key = element_blank()) +
  labs(x = pcoa1, y = pcoa2,title="PCOA" ,color = '')+
  #scale_color_manual(values=c("#45bd9b","#fece71","#f05179"),breaks=c("0", "1", "2"),labels=c("WC_obsity" ,"same", "ABSI_obesity"))+
  scale_color_manual(values=c("#f05179","#45bd9b"),breaks=c("1","2"),labels=c("ABSI_obesity","WC_obsity"))+
  stat_ellipse(aes(x = pcoa1, y = pcoa2, color =as.factor(group)), level = 0.95, linetype = 4, show.legend = FALSE) +  #95% CI
  geom_point(data = group_average, aes(x = pcoa1, y = pcoa2, color = as.factor(group)), size = 2, show.legend = FALSE)+  
  annotate('text', label = 'PERMANOVA', x = 0.1, y = 0.5, size = 3) +
  annotate('text', label = sprintf('italic(P) == %.3f', adonis_pri$aov.tab[1,6]), x = 0.1, y = 0.45, size = 3, parse = TRUE)  #PERMANOVA result P value
#----------------------------------

##------------NMDS-----------------
sol <- metaMDS(pri)
NMDS = data.frame(MDS1 = sol$points[,1], MDS2 = sol$points[,2])
site <- cbind.data.frame(NMDS, group)

##Add the centroids of the two groups to the graph 
#calculate the mean values of the two groups of samples in the PCOA coordinates, respectively
#and display them as large central points
group_average <- aggregate(cbind(MDS1, MDS2)~ABSI_group, data = site, FUN = mean)

##ggplot
ggplot(site)+
  geom_point(aes(x=MDS1, y=MDS2,color=as.factor(ABSI_group)),size = 0.5)+
  theme(panel.grid = element_blank(), panel.background = element_blank(),
        axis.line = element_line(color = 'black'), legend.key = element_blank()) +
  labs(x ="MDS1", y ="MDS2",title="NMDS" ,color = '')+
  #scale_color_manual(values=c("#45bd9b","#fece71","#f05179"),breaks=c("0","1","2"),labels=c("WC_obsity","same","ABSI_obesity"))+
  scale_color_manual(values=c("#f05179","#45bd9b"),breaks=c("1","2"),labels=c("ABSI_obesity","WC_obsity"))+
  scale_x_continuous(limits = c(-1,1.5))+  
  scale_y_continuous(limits = c(-1,2))+  
  stat_ellipse(aes(x = MDS1, y = MDS2, color =as.factor(ABSI_group)), level = 0.95, linetype = 2, show.legend = FALSE) +  
  geom_point(data = group_average, aes(x = MDS1, y = MDS2, color = as.factor(ABSI_group)), size = 2, show.legend = FALSE)+ 
  annotate('text', label=paste("Stress:",round(sol$stress,3)), x = 0, y = 1.5, size = 4)  

#------------------hjy--------------------------
